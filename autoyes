#!/bin/bash
# AutoYes - Shell wrapper for transparent command proxying with auto-approval
# This script auto-installs itself on first run and runs any command through the PTY proxy

set -e

# Configuration
AUTOYES_HOME="${HOME}/.autoyes"
VENV_DIR="${AUTOYES_HOME}/venv"
PYTHON_SCRIPT="${AUTOYES_HOME}/autoyes.py"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# First-time setup
setup_autoyes() {
    echo -e "${BLUE}[AutoYes Setup]${NC} First-time setup..."
    
    # Create directory structure
    mkdir -p "${AUTOYES_HOME}"
    
    # Create virtual environment if it doesn't exist
    if [ ! -d "${VENV_DIR}" ]; then
        echo -e "${BLUE}[AutoYes Setup]${NC} Creating virtual environment..."
        python3 -m venv "${VENV_DIR}"
    fi
    
    # Check if Python script exists
    if [ ! -f "${PYTHON_SCRIPT}" ]; then
        echo -e "${YELLOW}[AutoYes Setup]${NC} Python script not found at ${PYTHON_SCRIPT}"
        echo -e "${YELLOW}[AutoYes Setup]${NC} Please run 'make install' from the autoyes source directory"
        exit 1
    fi
    
    # Make sure the script is executable
    chmod +x "${PYTHON_SCRIPT}"
    
    echo -e "${GREEN}[AutoYes Setup]${NC} Setup complete!"
    echo -e "${GREEN}[AutoYes Setup]${NC} Location: ${AUTOYES_HOME}"
    echo ""
}

# Check if setup is needed
if [ ! -d "${VENV_DIR}" ] || [ ! -f "${PYTHON_SCRIPT}" ]; then
    setup_autoyes
fi

# Check if a command was provided
if [ $# -eq 0 ]; then
    echo "Usage: autoyes <command> [args...]" >&2
    echo "" >&2
    echo "Examples:" >&2
    echo "  autoyes <command>" >&2
    echo "  autoyes cursor" >&2
    echo "  autoyes terraform apply" >&2
    echo "" >&2
    echo "Run 'autoyes --help' for more information" >&2
    exit 1
fi

# Run AutoYes with the specified command
exec "${VENV_DIR}/bin/python3" "${PYTHON_SCRIPT}" "$@"
